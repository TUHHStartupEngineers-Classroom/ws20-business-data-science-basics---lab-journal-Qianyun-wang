---
title: "Journal (reproducible report)"
author: "Qianyun Wang"
date: "2020-11-24"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    code_folding: hide
---
***
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

**NOTE:** This file displays both course results and challenge result.

***
# Intro to the tidyverse

Last compiled: `r Sys.Date()`

course result and challenge result

## Course Result

> **Sales by Year and Category Analyse**

***

```{r plot, fig.width=7, fig.height=4,echo = FALSE}
# 1.0 Load libraries ----
library(tidyverse)
library(readxl)

# 2.0 Importing Files ----
bikes_tbl <- read_excel(path="~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx") 
order_tbl <- read_excel(path = "~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
bikeshop_tbl <-read_excel(path = "~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")

# 4.0 Joining Data ----
bike_orderlines_joined_tbl <- order_tbl %>%
  left_join(bikes_tbl,by=c('product.id'='bike.id')) %>%
  left_join(bikeshop_tbl,by=c('customer.id'='bikeshop.id'))

# 5.0 Wrangling Data ----
bike_orderlines_wrangled_tbl <- bike_orderlines_joined_tbl %>%
  separate(col= category,
           into = c('category.1','category.2','category.3'),
           sep = '-') %>%
  mutate(total.price = price * quantity) %>%
  
  select(-...1, -gender) %>%
  select(-ends_with('.id'))%>%
  bind_cols(bike_orderlines_joined_tbl %>% select(order.id))%>%
  
  select(order.id, contains('order'),contains('model'),contains('category'),
         price, quantity, total.price,
         everything()) %>%
 
  rename(bikeshop = name) %>%
  set_names(names(.) %>% str_replace_all('\\.','_'))

# 6.0 Business Insights ----
# 6.1 Sales by Year ----

# Step 1 - Manipulate
library(lubridate)
sales_by_year_tbl <- bike_orderlines_wrangled_tbl %>%
  select(order_date, total_price) %>%
  mutate(year=year(order_date))%>%
  group_by(year) %>%
  summarise(sales=sum(total_price))%>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = '.',
                                    decimal.mark =',',
                                    prefix = '',
                                    suffix =" €"
                                    ))

# Step 2 - Visualize
sales_by_year_tbl %>%
  ggplot(aes(x = year, y= sales)) +
  
  geom_col(fill="#2DC6D6") +
  geom_label(aes(label=sales_text))+
  geom_smooth(method = 'lm',se=FALSE) +
  
  scale_y_continuous(labels = scales::dollar_format(big.mark ='.',
                                                    decimal.mark =',',
                                                    prefix = '',
                                                    suffix =" €" ))+
  labs(
    title = 'Revenue by year',
    subtitle = "Upward Trend",
    x="",
    y="Revenue"
  )

# 6.2 Sales by Year and Category 2 ----
# Step 1 - Manipulate

sales_by_year_cat_1_tbl <- bike_orderlines_wrangled_tbl %>%
  select(order_date, total_price, category_1) %>%
  mutate(year=year(order_date))%>%
  group_by(year, category_1) %>%
  summarise(sales = sum(total_price))%>%
  ungroup() %>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = '.',
                                     decimal.mark =',',
                                     prefix = '',
                                     suffix =" €"
  ))

# Step 2 - Visualize
sales_by_year_cat_1_tbl %>%
  ggplot(aes(x=year,y=sales, fill=category_1))+
  
  geom_col()+
  geom_smooth(method = 'lm',se=FALSE) +
  
facet_wrap(~category_1)+

  scale_y_continuous(labels = scales::dollar_format(big.mark ='.',
                                                    decimal.mark =',',
                                                    prefix = '',
                                                    suffix =" €" ))+
  labs(
    title = 'Revenue by year and main category',
    subtitle = "Each product category has an upward Trend",
    fill="Main category"
  )

```

***
## Challenge Result

> **Sales by Location and Year Analyse**

> 1.Analyze the sales by location (state) with a bar plot. Since state and city are multiple features (variables), they should be split. Which state has the highes revenue?

* **Answer**: North Rhine-Westphalia

> 2.Analyze the sales by location and year (facet_wrap). Because there are 12 states with bike stores, you should get 12 plots.

* **Answer**: Both plots below.

***
```{r plot2, fig.width=10, fig.height=7,echo = FALSE}
# 1.0 Load libraries ----
library(tidyverse)
library(readxl)

# 2.0 Importing Files ----
bikes_tbl <- read_excel(path="~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx") 
order_tbl <- read_excel(path = "~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
bikeshop_tbl <-read_excel(path = "~/Desktop/TUHH/Bussiness Data Science Basic/DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")

# 4.0 Joining Data ----
bike_orderlines_joined_tbl <- order_tbl %>%
  left_join(bikes_tbl,by=c('product.id'='bike.id')) %>%
  left_join(bikeshop_tbl,by=c('customer.id'='bikeshop.id'))

# Wrangling data ----
bike_orderlines_wrangled_2_tbl <- bike_orderlines_joined_tbl %>%
  separate(col= location,
           into = c('city','state'),
           sep = ',') %>%
  mutate(total.price = price * quantity) %>%
  
  select(-...1, -gender,-category) %>%
  select(-ends_with('.id'))%>%
  bind_cols(bike_orderlines_joined_tbl %>% select(order.id))%>%
  
  select(order.id, contains('order'),contains('state'),contains('city'),
         price, quantity, total.price,
         everything())

# Sales by Location ----

# Step 1 - Manipulate
sales_by_loc_tbl <- bike_orderlines_wrangled_2_tbl %>%
  select(state, total.price) %>%
  group_by(state) %>%
  summarise(sales=sum(total.price))%>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = '.',
                                     decimal.mark =',',
                                     prefix = '',
                                     suffix =" €"
  ))

# Step 2 - Visualize
sales_by_loc_tbl %>%
  ggplot(aes(x = state, y= sales)) +
  
  geom_col(fill="#2DC6D6") +
  geom_label(aes(label=sales_text))+
  
  scale_y_continuous(labels = scales::dollar_format(big.mark ='.',
                                                    decimal.mark =',',
                                                    prefix = '',
                                                    suffix =" €" ))+
  
  labs(
    title = 'Sales by state',
    subtitle = "Top state: North Rhine-Westphalia",
    x="",
    y="Revenue"
  )+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Sales by Year and Location ----
# Step 1 - Manipulate

sales_by_year_loc_tbl <- bike_orderlines_wrangled_2_tbl %>%
  select(order.date, total.price, state) %>%
  mutate(year=year(order.date))%>%
  group_by(year, state) %>%
  summarise(sales = sum(total.price))%>%
  ungroup() %>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = '.',
                                     decimal.mark =',',
                                     prefix = '',
                                     suffix =" €"
  ))

# Step 2 - Visualize
sales_by_year_loc_tbl %>%
  ggplot(aes(x=year,y=sales, fill=state))+
  
  geom_col()+
  geom_smooth(method = 'lm',se=FALSE) +
  
  facet_wrap(~state)+
  
  scale_y_continuous(labels = scales::dollar_format(big.mark ='.',
                                                    decimal.mark =',',
                                                    prefix = '',
                                                    suffix =" €" ))+
  labs(
    title = 'Revenue by year and state',
    subtitle = "Most state has an upward Trend",
    fill="State"
  )

```

***
# Data Acquisition

Last compiled: `r Sys.Date()`

## Get Data via API 
> I get the daily visit data as pv of the wikipedia page: Coronavirus_disease_2019 (https://en.wikipedia.org/w/index.php?title=Coronavirus_disease_2019&redirect=no), the time period is set to recent 10 days and can be changed in the R code freely.  The result of json format and list format is shown below.

```{r echo=TRUE}
library(tidyverse)
library(httr)
library(jsonlite)

starting <- "20201114"
ending <- "20201124"
article_title <- 'Coronavirus_disease_2019'

url <- paste("https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/en.wikipedia/all-access/all-agents",
             article_title,
             "daily",
             starting,
             ending,
             sep = "/")

resp <-GET(url)

toJSON(fromJSON(content(resp, as="text")), pretty = TRUE)
result <- fromJSON(content(resp, as="text"))
result
```

# Adding R stuff

So far this is just a blog where you can write in plain text and serve your writing to a webpage. One of the main purposes of this lab journal is to record your progress learning R. The reason I am asking you to use this process is because you can both make a website, and a lab journal, and learn R all in R-studio. This makes everything really convenient and in the same place. 

So, let's say you are learning how to make a histogram in R. For example, maybe you want to sample 100 numbers from a normal distribution with mean = 0, and standard deviation = 1, and then you want to plot a histogram. You can do this right here by using an r code block, like this:

```{r}
samples <- rnorm(100, mean=0, sd=1)
hist(samples)
```

When you knit this R Markdown document, you will see that the histogram is printed to the page, along with the R code. This document can be set up to hide the R code in the webpage, just delete the comment (hashtag) from the cold folding option in the yaml header up top. For purposes of letting yourself see the code, and me see the code, best to keep it the way that it is. You'll learn that all of these things and more can be customized in each R code block.